<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
  <title>Ludo Â· Spill</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&display=swap" rel="stylesheet" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; touch-action: manipulation; width: 100%; height: 100%; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      margin: 0; padding: 0;
      width: 100%; height: 100%; min-height: 100%;
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; flex-direction: column; align-items: stretch;
      background: linear-gradient(180deg, #4ade80 0%, #22c55e 50%, #16a34a 100%);
      -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none;
    }

    .status-card {
      flex-shrink: 0;
      background: rgba(255,255,255,0.95);
      padding: 12px 16px;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .status-card .status-text { color: #166534; font-size: 1rem; font-weight: 700; }
    .status-card .status-sub { color: #15803d; font-size: 0.85rem; margin-top: 2px; opacity: 0.9; }
    .status-card.you-turn .status-text { color: #166534; }
    .status-card.game-over .status-text { color: #b45309; font-weight: 800; }
    .status-card.game-over.win .status-text { color: #15803d; }
    .status-card.game-over.lose .status-text { color: #dc2626; }
    .game-over-actions { display: flex; gap: 12px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
    .game-over-actions.hidden { display: none !important; }
    .btn-game-over {
      padding: 12px 24px; border-radius: 12px; font-size: 1rem; font-weight: 700; border: none;
      cursor: pointer; font-family: inherit;
    }
    .btn-replay { background: #22c55e; color: #fff; box-shadow: 0 2px 8px rgba(34,197,94,0.4); }
    .btn-leave { background: #e5e7eb; color: #374151; }

    .game-area {
      flex: 1; min-height: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px;
    }
    .board-wrap {
      width: min(92vmin, 340px);
      height: min(92vmin, 340px);
      background: linear-gradient(145deg, #fef3c7 0%, #fde68a 30%, #fcd34d 100%);
      border-radius: 24px;
      padding: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25), 0 0 0 4px #b45309, inset 0 2px 0 rgba(255,255,255,0.6);
      position: relative;
    }
    .track {
      width: 100%; height: 100%;
      display: grid;
      grid-template-columns: repeat(11, 1fr);
      grid-template-rows: repeat(11, 1fr);
      gap: 2px;
      position: relative;
    }
    .cell {
      border-radius: 50%;
      background: rgba(255,255,255,0.7);
      border: 2px solid #d97706;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.8);
    }
    .cell.path { background: #fef9c3; border-color: #ca8a04; }
    .cell.start { background: #86efac; border-color: #16a34a; box-shadow: 0 0 0 2px #15803d; }
    .cell.end { background: linear-gradient(145deg, #fbbf24, #f59e0b); border-color: #d97706; color: #78350f; font-weight: 800; font-size: 10px; }
    .cell .token {
      position: absolute;
      width: 70%;
      height: 70%;
      border-radius: 50%;
      box-shadow: 0 3px 8px rgba(0,0,0,0.35);
      border: 3px solid rgba(255,255,255,0.9);
    }
    .cell .token.p0 { background: linear-gradient(145deg, #ef4444, #b91c1c); }
    .cell .token.p1 { background: linear-gradient(145deg, #3b82f6, #1d4ed8); }

    .dice-section {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .dice-wrap {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      background: linear-gradient(145deg, #fff 0%, #f3f4f6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 #fff;
      border: 3px solid #e5e7eb;
    }
    .dice-pips {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 4px;
      width: 44px;
      height: 44px;
      padding: 4px;
    }
    .dice-pips .pip {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #1f2937;
      margin: auto;
    }
    .dice-pips .pip.hide { opacity: 0; }
    .dice-wrap.empty .dice-pips .pip { opacity: 0.2; }
    .roll-btn {
      padding: 16px 40px;
      font-size: 1.1rem;
      font-weight: 800;
      background: linear-gradient(145deg, #22c55e, #16a34a);
      color: #fff;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-family: inherit;
      box-shadow: 0 4px 16px rgba(34,197,94,0.5);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: transform 0.1s;
    }
    .roll-btn:hover:not(:disabled) { transform: scale(1.05); }
    .roll-btn:active:not(:disabled) { transform: scale(0.98); }
    .roll-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="statusCard" class="status-card">
    <div id="statusText" class="status-text">Connecting...</div>
    <div id="statusSub" class="status-sub"></div>
    <div id="gameOverActions" class="game-over-actions hidden">
      <button type="button" class="btn-game-over btn-replay">Replay</button>
      <button type="button" class="btn-game-over btn-leave">Leave</button>
    </div>
  </div>
  <div id="gameArea" class="game-area hidden">
    <div class="board-wrap">
      <div id="track" class="track"></div>
    </div>
    <div class="dice-section">
      <div id="diceWrap" class="dice-wrap empty">
        <div id="dicePips" class="dice-pips"></div>
      </div>
      <button type="button" id="rollBtn" class="roll-btn">Roll dice</button>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const roomCode = params.get('room') || '';
    const opponentFromUrl = (params.get('opponent') || params.get('opponentName') || '').trim().slice(0, 30);
    const socket = io('/ludo');
    const statusCard = document.getElementById('statusCard');
    const statusText = document.getElementById('statusText');
    const statusSub = document.getElementById('statusSub');
    const gameArea = document.getElementById('gameArea');
    const trackEl = document.getElementById('track');
    const diceWrap = document.getElementById('diceWrap');
    const dicePips = document.getElementById('dicePips');
    const rollBtn = document.getElementById('rollBtn');
    const gameOverActionsEl = document.getElementById('gameOverActions');

    const LEN = 40;
    let myIndex = null;
    let opponentName = opponentFromUrl || 'Opponent';
    let state = { positions: [0, 0], turn: 0, lastDice: 0, winner: null };

    function pathPosition(i) {
      if (i <= 9) return { row: 0, col: i + 1 };
      if (i <= 19) return { row: i - 9, col: 10 };
      if (i <= 29) return { row: 10, col: 29 - i };
      if (i <= 38) return { row: 39 - i, col: 0 };
      return { row: 0, col: 0 };
    }

    const DICE_LAYOUT = {
      1: [0,0,0,0,1,0,0,0,0],
      2: [1,0,0,0,0,0,0,0,1],
      3: [1,0,0,0,1,0,0,0,1],
      4: [1,0,1,0,0,0,1,0,1],
      5: [1,0,1,0,1,0,1,0,1],
      6: [1,0,1,1,0,1,1,0,1],
    };

    function setStatus(text, sub, classes) {
      statusText.textContent = text;
      statusSub.textContent = sub || '';
      statusCard.className = 'status-card ' + (classes || '');
    }

    function renderDice() {
      dicePips.innerHTML = '';
      const n = state.lastDice || 0;
      const layout = DICE_LAYOUT[n] || [0,0,0,0,0,0,0,0,0];
      for (let i = 0; i < 9; i++) {
        const pip = document.createElement('div');
        pip.className = 'pip' + (layout[i] ? '' : ' hide');
        dicePips.appendChild(pip);
      }
      diceWrap.classList.toggle('empty', !n);
    }

    function render() {
      trackEl.innerHTML = '';
      trackEl.style.gridTemplateColumns = 'repeat(11, 1fr)';
      trackEl.style.gridTemplateRows = 'repeat(11, 1fr)';
      for (let i = 0; i < LEN; i++) {
        const { row, col } = pathPosition(i);
        const cell = document.createElement('div');
        cell.className = 'cell path';
        cell.style.gridRow = row + 1;
        cell.style.gridColumn = col + 1;
        if (i === 0) cell.classList.add('start');
        if (i === LEN - 1) {
          cell.classList.add('end');
          const lbl = document.createElement('span');
          lbl.textContent = 'HOME';
          lbl.style.fontSize = '9px';
          cell.appendChild(lbl);
        }
        if (state.positions[0] === i) {
          const t = document.createElement('span');
          t.className = 'token p0';
          cell.appendChild(t);
        }
        if (state.positions[1] === i) {
          const t = document.createElement('span');
          t.className = 'token p1';
          cell.appendChild(t);
        }
        trackEl.appendChild(cell);
      }
      renderDice();
      rollBtn.disabled = state.winner !== null || state.turn !== myIndex;

      if (state.winner !== null) {
        if (state.winner === myIndex) setStatus('You win!', 'Well played!', 'game-over win');
        else setStatus('You lose', opponentName + ' won.', 'game-over lose');
        gameOverActionsEl.classList.remove('hidden');
      } else {
        gameOverActionsEl.classList.add('hidden');
        if (state.turn === myIndex) setStatus('Your turn', 'Tap Roll dice!', 'you-turn');
        else setStatus(opponentName + "'s turn", 'Waiting for their roll...', '');
      }
    }

    socket.on('connect', () => {
      if (roomCode) {
        setStatus('Joining game...', '', '');
        socket.emit('joinOrCreate', { roomCode, name: 'Player' });
      } else setStatus('Open with ?room= from the Spill app.', '', '');
    });

    socket.on('waiting', () => {
      gameArea.classList.add('hidden');
      setStatus('Waiting for opponent...', 'Share the game link or wait.', '');
    });

    socket.on('start', (data) => {
      myIndex = data.playerIndex;
      if (!opponentName || opponentName === 'Opponent') {
        opponentName = (data.opponent || 'Opponent').trim().slice(0, 30) || 'Opponent';
      }
      gameArea.classList.remove('hidden');
      state = { positions: [0, 0], turn: 0, lastDice: 0, winner: null };
      render();
    });

    socket.on('state', (data) => {
      state = data;
      render();
    });

    rollBtn.addEventListener('click', () => socket.emit('roll', { roomCode }));

    socket.on('roomFull', () => setStatus('Room full.', '', ''));
    socket.on('opponentLeft', () => setStatus('Opponent left.', 'You can go back.', ''));

    gameOverActionsEl.addEventListener('click', (e) => {
      if (e.target.classList.contains('btn-replay')) window.location.reload();
      else if (e.target.classList.contains('btn-leave')) {
        if (window.ReactNativeWebView && typeof window.ReactNativeWebView.postMessage === 'function') {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'leave' }));
        } else window.close();
      }
    });
  </script>
</body>
</html>
