<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
  <title>Ludo · Spill</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; touch-action: manipulation; }
    body { font-family: system-ui, sans-serif; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8fafc; padding: 12px 16px; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
    .status { color: #64748b; margin-bottom: 10px; text-align: center; font-size: 0.9rem; }
    .track { display: flex; flex-wrap: wrap; gap: 4px; max-width: 320px; justify-content: center; }
    .cell { width: 28px; height: 28px; border-radius: 6px; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
    .cell.p0 { background: #ec4899; color: #fff; }
    .cell.p1 { background: #8b5cf6; color: #fff; }
    .rollBtn { margin-top: 16px; padding: 12px 24px; font-size: 16px; font-weight: 700; background: #ec4899; color: #fff; border: none; border-radius: 12px; cursor: pointer; }
    .rollBtn:disabled { opacity: 0.5; cursor: not-allowed; }
    .dice { margin-top: 8px; font-size: 2rem; }
    .hidden { display: none !important; }
    .winner { color: #10b981; font-weight: 700; }
  </style>
</head>
<body>
  <p id="status" class="status">Connecting...</p>
  <div id="game" class="hidden">
    <p id="dice" class="dice"></p>
    <div id="track" class="track"></div>
    <button type="button" id="rollBtn" class="rollBtn">Roll dice</button>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const roomCode = params.get('room') || '';
    const socket = io('/ludo');
    const statusEl = document.getElementById('status');
    const gameEl = document.getElementById('game');
    const trackEl = document.getElementById('track');
    const diceEl = document.getElementById('dice');
    const rollBtn = document.getElementById('rollBtn');
    const LEN = 40;
    let myIndex = null;
    let state = { positions: [0, 0], turn: 0, lastDice: 0, winner: null };

    function render() {
      trackEl.innerHTML = '';
      for (let i = 0; i < LEN; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        if (state.positions[0] === i) cell.classList.add('p0');
        if (state.positions[1] === i) cell.classList.add('p1');
        cell.textContent = i + 1;
        trackEl.appendChild(cell);
      }
      diceEl.textContent = state.lastDice ? 'Last roll: ' + state.lastDice : '';
      rollBtn.disabled = state.winner !== null || state.turn !== myIndex;
      if (state.winner !== null) statusEl.textContent = state.winner === myIndex ? 'You win!' : 'You lose.';
      else statusEl.textContent = state.turn === myIndex ? 'Your turn — roll!' : "Opponent's turn";
    }

    socket.on('connect', () => {
      if (roomCode) {
        statusEl.textContent = 'Joining game...';
        socket.emit('joinOrCreate', { roomCode, name: 'Player' });
      } else statusEl.textContent = 'Open with ?room= from the Spill app.';
    });

    socket.on('waiting', () => {
      gameEl.classList.add('hidden');
      statusEl.textContent = 'Waiting for opponent...';
    });

    socket.on('start', (data) => {
      myIndex = data.playerIndex;
      gameEl.classList.remove('hidden');
      state = { positions: [0, 0], turn: 0, lastDice: 0, winner: null };
      render();
    });

    socket.on('state', (data) => {
      state = data;
      render();
    });

    rollBtn.addEventListener('click', () => socket.emit('roll', { roomCode }));

    socket.on('roomFull', () => statusEl.textContent = 'Room full.');
    socket.on('opponentLeft', () => statusEl.textContent = 'Opponent left.');
  </script>
</body>
</html>
